<!doctype html>
<html lang="en">

  <head>
    <meta charset="utf-8">

    <title>Ansible meetup #9</title>

    <meta name="description" content="Utilisation d'Ansible avec Docker (et réciproquement)">
    <meta name="author" content="Yannig Perré">

    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">

    <link rel="stylesheet" href="../reveal/css/reveal.css">
    <link rel="stylesheet" href="../reveal/css/theme/black.css" id="theme">

    <!-- Code syntax highlighting -->
    <link rel="stylesheet" href="../reveal/lib/css/zenburn.css">

    <!-- Printing and PDF exports -->
    <script>
      var link = document.createElement( 'link' );
      link.rel = 'stylesheet';
      link.type = 'text/css';
      link.href = window.location.search.match( /print-pdf/gi ) ? '../reveal/css/print/pdf.css' : '../reveal/css/print/paper.css';
      document.getElementsByTagName( 'head' )[0].appendChild( link );
    </script>

    <!--[if lt IE 9]>
    <script src="../reveal/lib/js/html5shiv.js"></script>
    <![endif]-->
  </head>

  <body>

    <div class="reveal">

      <!-- Any section element inside of this container is displayed as a slide -->
      <div class="slides">
        <section data-background="#ffffff">
          <h1>Ansible Meetup</h1>
          <h4>Utilisation d'Ansible avec Docker</h4>
          <img src="images/logo_ansible.png" height="160" />
          <img src="images/docker.png" height="160" />
          <p><small><a href="http://lesaventuresdeyannigdanslemondeit.blogspot.fr/">Yannig Perré</a> / <a href="https://twitter.com/YannigPerre">@cgi.com</a></small></p>
          <img src="images/CGI_logo.png" width=160/>
        </section>

        <section>
          <h2>Me concernant</h2>
          <ul>
            <li>Administrateur système et Java</li>
            <li>Architecte applicatif/système</li>
          </ul>
        </section>

        <section data-background="#dddddd">
          <h2>Contexte de travail</h2>
          <ul>
              <li>Applications 3 tiers classiques</li>
              <li>Gestion d'infra</li>
              <li>Divers briques</li>
          </ul>
        </section>

        <section>
          <h2>Méthodologie de déploiement</h2>
          <h4>Ansible et Jenkins depuis 1 an</h4>
          <ul>
              <li>Déploiement d'application J2E</li>
              <li>Gestion de la BDD</li>
              <li>Gestion exploitation</li>
          </ul>
        </section>

        <section data-background="#aaa">
          <h2>Exemple de playbook</h2>
          <pre><code class=YAML contenteditable data-trim >
---

- name: "Création du groupe batch"
  group: name={{batch_group}}

- name: "Création du user batch"
  user: name={{batch_user}} group={{batch_group}} createhome=yes
          </code></pre>
        </section>

        <section>
          <h2>REX Ansible</h2>
          <ul>
            <li>Gains
              <ul>
                <li>Déploiement plus rapide</li>
                <li>Plus de sécurité au niveau des déploiements</li>
              </ul>
            </li>
            <li>Mais dans les faits peu de temps gagné
              <ul>
                <li>Nouvelles procédures</li>
                <li>Déroulement toujours manuels des procédures</li>
              </ul>
            </li>
          </ul>
        </section>

        <section>
          <h2>Refactoring en cours</h2>
          <ul>
              <li>Réduire la complexité des inventaires</li>
              <li>Reprise des valeurs dans des rôles spécifiques</li>
              <li>Jobs d'enchaînements sous Jenkins</li>
          </ul>
        </section>

        <section>
          <h2>Démo Oracle</h2>
          <ul>
            <li>Création des tablespaces</li>
            <li>Création du schéma de BDD</li>
          </ul>
          <pre><code class=shell contenteditable data-trim >
./better-call-ansible.sh DOCKER/ERDF/DEV/DEV1 -e app_name=efluid \
    playbooks/common/oracle-tablespace.yml \
    playbooks/common/oracle-users.yml
</code></pre>
        </section>

        <section>
          <h2>Bref, ça marche bien !</h2>
          <img src='images/its_all_working.gif' />
        </section>

        <section>
          <h2>Mais maintenant que ça marche</h2>
          <ul>
              <li>Besoin de diffuser</li>
              <li>En prérequis : faire quelques tests</li>
              <li>Et si on utilisait Docker ?</li>
          </ul>
          <img src='images/il_faudrait_versionner.gif' width="300" style="float:right" />
        </section>

        <section>
          <h2>Début d'utilisation de Docker</h2>

          <ul>
            <li>Comment s'y connecter ?
              <ul>
                <li>En lançant un démon SSH ?</li>
                <li>Mieux : connecteur natif sous Ansible v2 !</li>
              </ul>
            </li>
          </ul>
        </section>

        <section>
          <h2>Les problèmes Dockers</h2>
          <section>
            <h4>Les triviaux</h4>
            <ul>
              <li>Le container doit "tourner"
                <pre>tail -f /dev/null ou /usr/lib/systemd/systemd</pre>
              </li>
              <li>Attention saturation des FS</li>
            </ul>
          </section>
          <section>
            <h4>Un peu plus drôle</h4>
            <ul>
              <li>Problème drivers storage ubuntu
                <pre>yum install httpd => cpio: cap_set_file</pre></li>
              <li>Utilisation de <b>/var/lib/docker</b> sous btrfs</li>
            </ul>
          </section>
          <section>
            <h4>Les blagues de systemd</h4>
            <ul>
              <li>Erreurs D-Bus<pre>Failed to get D-Bus connection: Operation not permitted</pre>
                <ul><li>Utilisation du mode privileged</li></ul>
              </li>
              <li>Si pas besoin des services, mode <a href='https://github.com/maci0/docker-systemd-unpriv'>unprivileged</a></li>
            </ul>
          </section>
        </section>

        <section>
          <h2>Démo mediawiki Part I</h2>
          <ul>
            <li>Création images + containers</li>
            <li>Déploiement de MariaDB</li>
            <li>Déploiement d'apache</li>
            <li>Installation de mediawiki</li>
          </ul>
          <pre><code class=shell contenteditable data-trim >
ansible-playbook -i inventory playbooks/destroy-container.yml
ansible-playbook -i inventory/single \
                    playbooks/install-mediawiki.yml
</code></pre>
        </section>

        <section>
          <h2>Retours sur l'utilisation de Docker</h2>
          <ul>
            <li>Ne remplace pas la virtualisation</li>
            <li>systemd n'est pas ton ami</li>
            <li>Peut demander quelques adaptations</li>
          </ul>
        </section>

        <section>
          <h2>Travaux en cours</h2>
          <h4>Mixer les deux outils</h4>
          <img src='images/ansible_docker.png' />
        </section>

        <section>
          <h2>La démarche</h2>
          <section>
            <h4>Docker pour :</h4>
            <ul>
              <li>La facilité de création d'environnement</li>
              <li>La réduction des temps de déploiement</li>
            </ul>
          </section>

          <section>
            <h4>Ansible va nous aider dans :</h4>
            <ul>
              <li>Création / lancement des containers</li>
              <li>Enchaînement des opérations</li>
            </ul>
          </section>
        </section>

        <section>
          <h2>Démo mediawiki Part II</h2>
          <h4>Ajout d'un load-balancer</h4>
          <pre><code class=shell contenteditable data-trim >ansible-playbook -i inventory/load-balancer playbooks/install-mediawiki.yml</code></pre>
        </section>

        <section>
          <h2>En conclusion</h2>
          <ul>
            <li>Docker demande des adaptations</li>
            <li>Ansible n'a pas de contrainte
              <ul>
                <li>Gére l'infra classique</li>
                <li>Mais également du docker !</li>
              </ul>
            </li>
            <li>La combinaison vous permettra
              <ul>
                <li>De dérouler vos déploiements (Ansible)</li>
                <li>De réduire vos temps d'installation (Docker)</li>
              </ul>
            </li>
          </ul>
        </section>

      </div>

    </div>

    <script src="../reveal/lib/js/head.min.js"></script>
    <script src="../reveal/js/reveal.js"></script>

    <script>

      // Full list of configuration options available at:
      // https://github.com/hakimel/reveal.js#configuration
      Reveal.initialize({
          controls: true,
          progress: true,
          history: true,
          center: true,

          transition: 'convex', // none/fade/slide/convex/concave/zoom

          // Optional reveal.js plugins
          dependencies: [
              { src: '../reveal/lib/js/classList.js', condition: function() { return !document.body.classList; } },
              { src: '../reveal/plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
              { src: '../reveal/plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
              { src: '../reveal/plugin/highlight/highlight.js', async: true, condition: function() { return !!document.querySelector( 'pre code' ); }, callback: function() { hljs.initHighlightingOnLoad(); } },
              { src: '../reveal/plugin/zoom-js/zoom.js', async: true },
              { src: '../reveal/plugin/notes/notes.js', async: true }
          ]
      });

    </script>

  </body>
</html>
